<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="{{ description or site.description }}">

  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="icon" type="image/png" href="/favicon.png" sizes="64x64" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="VR Blog" />
  <link rel="manifest" href="/site.webmanifest" />
  <link rel="stylesheet" href="/styles/main.css">
  <link rel="canonical" href="{{ site.url }}{{ page.url | url }}" />

  <title>{{metaTitle}}</title>

  <link rel="alternate" type="application/rss+xml"  title="{{ site.title }}" href="{{ '/feed.xml' | absoluteUrl(site.url) }}">
  <link rel="alternate" type="application/atom+xml" title="{{ site.title }}" href="{{ '/atom.xml' | absoluteUrl(site.url) }}">

  {% block head %}{% endblock %}
</head>
<body class="{{ bodyClass or '' }}">
  <a class="skip-link" href="#content">Skip to content</a>
  {% include "components/header.njk" %}

  <div class="main">
    {% block content %}{% endblock %}
    <aside class="sidebar" role="complementary">
      {% block sidebar %}{% endblock %}
    </aside>
  </div>

  {% include "components/footer.njk" %}

  <!--  //TODO externalize-->
  <script>
    (() => {
      let booting = null;

      function loadCSS(href) {
        return new Promise((resolve, reject) => {
          const el = document.createElement('link');
          el.rel = 'stylesheet';
          el.href = href;
          el.onload = resolve;
          el.onerror = reject;
          document.head.appendChild(el);
        });
      }

      function loadJS(src) {
        return new Promise((resolve, reject) => {
          const s = document.createElement('script'); // classic script, NOT type="module"
          s.src = src;
          s.onload = resolve;
          s.onerror = () => reject(new Error('Failed to load ' + src));
          document.head.appendChild(s);
        });
      }

      async function ensureSearch() {
        if (booting) return booting;
        const container = document.querySelector('#search');
        if (!container) throw new Error('Search container #search not found');

        booting = (async () => {
          await loadJS('/pagefind/pagefind-ui.js');

          if (!window.PagefindUI) throw new Error('window.PagefindUI not available');
          // Optional: clear container if you had placeholder content
          container.innerHTML = '';

          new window.PagefindUI({
            element: '#search',
            showSubResults: false,
            showImages: false,
            resetStyles: false,
            translations: {
              placeholder: "Search…",
              one_result: "Found 1 result for '[SEARCH_TERM]'.",
              many_results: "Found [COUNT] results for '[SEARCH_TERM]'.",
              zero_results: "No results found for '[SEARCH_TERM]'.",
              search_label: "Search the site",
              clear_search: "×",
              load_more: "Load more"
            }

          });

          //TODO extract and refactor
          queueMicrotask(() => {
            const drawer = document.querySelector(".pagefind-ui__drawer");
            const input  = document.querySelector(".pagefind-ui__search-input");

            // 1) Vytvoř backdrop (jen jednou)
            let backdrop = document.querySelector(".backdrop-search");
            if (!backdrop) {
              backdrop = document.createElement("div");
              backdrop.className = "backdrop-search";
              document.body.appendChild(backdrop);
            }

            // 2) Klik na backdrop zavře vyhledávání
            backdrop.addEventListener("click", () => {
              if (input) {
                input.value = "";
                input.dispatchEvent(new Event("input", { bubbles: true }));
                input.blur();
              }
              hideBackdrop();
            });

            // 3) Sleduj otevření/skrývání draweru (Pagefind přepíná class)
            const mo = new MutationObserver(() => {
              const open = drawer && !drawer.classList.contains("pagefind-ui__hidden");
              document.body.classList.toggle("search-open", open);
              backdrop.classList.toggle("is-visible", open);
              if (open) input?.focus();
            });
            if (drawer) mo.observe(drawer, { attributes: true, attributeFilter: ["class"] });

            // 4) ESC zavře
            window.addEventListener("keydown", (e) => {
              if (e.key === "Escape" && drawer && !drawer.classList.contains("pagefind-ui__hidden")) {
                input.value = "";
                input.dispatchEvent(new Event("input", { bubbles: true }));
                input.blur();
                hideBackdrop();
              }
            });

            function hideBackdrop() {
              document.body.classList.remove("search-open");
              backdrop.classList.remove("is-visible");
            }
          });
          document.querySelector(".pagefind-ui__search-input").focus({ preventScroll: true });
        })().catch(err => { console.error(err); booting = null; });

        return booting;
      }

      // Hook up your trigger(s)
      const trigger = document.getElementById('open-search') || document.getElementById('search');
      if (trigger) {
        ['click','focus','mouseenter'].forEach(ev =>
          trigger.addEventListener(ev, () => { ensureSearch(); }, { once: true })
        );
      }

      // Keyboard shortcuts (optional)
      document.addEventListener('keydown', (e) => {
        const inField = /^(input|textarea|select)$/i.test(e.target.tagName) || e.target.isContentEditable;
        if (inField) return;
        const slash = e.key === '/';
        const modK  = (e.key.toLowerCase() === 'k') && (e.ctrlKey || e.metaKey);
        if (slash || modK) { e.preventDefault(); ensureSearch(); }
      });
    })();
  </script>

</body>
</html>